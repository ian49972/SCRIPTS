local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local TextService = game:GetService("TextService")
local CollectionService = game:GetService("CollectionService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local backpack = player:WaitForChild("Backpack")

local tool = Instance.new("Tool")
tool.Name = "RESET"
tool.RequiresHandle = false
tool.Parent = backpack

local assets = game:GetObjects(getcustomasset("CHARA.rbxmx"))[1]
local charaRig = assets:WaitForChild("Chara")
local cameraModel = assets:WaitForChild("ResetCam")
local cameraPart = cameraModel:WaitForChild("CamPart")
local cameraKfs = assets:WaitForChild("HitCam")
local charaKfs = assets:WaitForChild("Hit")

local camera = Workspace.CurrentCamera
local originalCameraType = camera.CameraType
local originalCameraSubject = camera.CameraSubject
local originalFieldOfView = camera.FieldOfView

local screenGui = Instance.new("ScreenGui")
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui

local blackFrame = Instance.new("Frame")
blackFrame.Size = UDim2.new(1,0,1,0)
blackFrame.BackgroundColor3 = Color3.new(0,0,0)
blackFrame.BackgroundTransparency = 1
blackFrame.Parent = screenGui

local slashImage = Instance.new("ImageLabel")
slashImage.Size = UDim2.new(0.8,0,0.8,0)
slashImage.Position = UDim2.new(0.5,0,0.5,0)
slashImage.AnchorPoint = Vector2.new(0.5,0.5)
slashImage.BackgroundTransparency = 1
slashImage.ImageTransparency = 1
slashImage.Image = "rbxassetid://140717784290365"
slashImage.Parent = screenGui

local damageImage = Instance.new("ImageLabel")
damageImage.Size = UDim2.new(1,0,1,0)
damageImage.Position = UDim2.new(0,0,0,0)
damageImage.BackgroundTransparency = 1
damageImage.ImageTransparency = 1
damageImage.Image = "rbxassetid://9662774715"
damageImage.Parent = screenGui

local tStyle = {
	[Enum.PoseEasingStyle.Linear] = Enum.EasingStyle.Linear,
	[Enum.PoseEasingStyle.Bounce] = Enum.EasingStyle.Bounce,
	[Enum.PoseEasingStyle.Cubic] = Enum.EasingStyle.Cubic,
	[Enum.PoseEasingStyle.Elastic] = Enum.EasingStyle.Elastic,
	[Enum.PoseEasingStyle.Constant] = Enum.EasingStyle.Linear,
}

local tDirection = {
	[Enum.PoseEasingDirection.In] = Enum.EasingDirection.In,
	[Enum.PoseEasingDirection.Out] = Enum.EasingDirection.Out,
	[Enum.PoseEasingDirection.InOut] = Enum.EasingDirection.InOut,
}

function PlayKeyframeSequence(Model, KeyFrameSequence, SpeedMult)
	SpeedMult = SpeedMult or 1
	local AllKeyFrames = {}
	for _, Keyframe in pairs(KeyFrameSequence:GetKeyframes()) do
		table.insert(AllKeyFrames, {Time = Keyframe.Time, Keyframe = Keyframe})
	end
	table.sort(AllKeyFrames, function(a,b) return a.Time < b.Time end)

	if #AllKeyFrames == 0 then return {getLength = function() return 0 end, stop = function() end} end

	local motors, motorValues = {}, {}

	local function GetMotorFromPose(Pose)
		for _, v in pairs(Model:GetDescendants()) do
			if v:IsA("Motor6D") and v.Part1 and v.Part1.Name == Pose.Name and v.Part0 and v.Part0.Name == Pose.Parent.Name then
				return v
			end
		end
	end

	for _, Keyframe in ipairs(AllKeyFrames) do
		for _, Pose in pairs(Keyframe.Keyframe:GetDescendants()) do
			if Pose:IsA("Pose") and Pose.Weight > 0 then
				local Motor6D = motors[Pose.Name] or GetMotorFromPose(Pose)
				if Motor6D then
					motors[Pose.Name] = Motor6D
					if not motorValues[Pose.Name] then
						local motorVal = Instance.new("CFrameValue")
						motorVal.Name = "MotorValue"
						motorVal.Parent = Motor6D
						motorVal.Value = Motor6D.Transform
						motorValues[Pose.Name] = motorVal
					end
				end
			end
		end
	end

	local tweens = {}
	local totalTime = 0
	if #AllKeyFrames > 1 then
		for i = 1, #AllKeyFrames - 1 do
			local KF1, KF2 = AllKeyFrames[i], AllKeyFrames[i+1]
			local duration = (KF2.Time - KF1.Time) / SpeedMult
			totalTime += duration

			for _, Pose in pairs(KF2.Keyframe:GetDescendants()) do
				if Pose:IsA("Pose") and Pose.Weight > 0 and motors[Pose.Name] then
					local tweenInfo = TweenInfo.new(
						duration,
						tStyle[Pose.EasingStyle] or Enum.EasingStyle.Linear,
						tDirection[Pose.EasingDirection] or Enum.EasingDirection.InOut
					)
					table.insert(tweens, {
						Tween = TweenService:Create(motorValues[Pose.Name], tweenInfo, {Value = Pose.CFrame}),
						Delay = totalTime - duration
					})
				end
			end
		end
	end

	local function getLength()
		return AllKeyFrames[#AllKeyFrames].Time / SpeedMult
	end

	local function play()
		for _, data in ipairs(tweens) do
			task.delay(data.Delay, function()
				data.Tween:Play()
			end)
		end
	end

	local connection = RunService.Heartbeat:Connect(function()
		for name, motor in pairs(motors) do
			if motorValues[name] then
				motor.Transform = motorValues[name].Value
			end
		end
	end)

	task.spawn(function()
		play()
		task.wait(getLength())
		connection:Disconnect()
	end)

	return {
		getLength = getLength,
		stop = function()
			connection:Disconnect()
			for _, data in ipairs(tweens) do
				if data.Tween then
					data.Tween:Cancel()
				end
			end
			for _, val in pairs(motorValues) do
				val:Destroy()
			end
		end
	}
end

local Object = game:GetObjects("rbxassetid://74714833540240")[1]
Object.Parent = workspace

local DialogueGui = Object.CUSTOM_DIALOGUE

local function getColor(timeLength, points)
	local data1 = points[1]
	local allPoints = points[#points]
	for i = 1, #points - 1 do
		if points[i].Time <= timeLength and timeLength <= points[i + 1].Time then
			data1 = points[i]
			allPoints = points[i + 1]
			local newPoint = (timeLength - data1.Time) / (allPoints.Time - data1.Time)
			return data1.Value:Lerp(allPoints.Value, newPoint)
		end
	end
	return data1.Value
end

local function EndDialogue(gui)
	for _, v in gui:GetChildren() do
		if v.Name == "letter" then
			v:SetAttribute("Ending", true)
			TweenService:Create(v, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
				Position = v.Position + UDim2.new(0, 0, 0, 50),
				TextTransparency = 1,
				TextStrokeTransparency = 1
			}):Play()
			game.Debris:AddItem(v, 0.4)
		end
	end
end

local function CreateDialogue(data, displayName)
	displayName = player.Name
	local DialogueUI = DialogueGui:Clone()
	local posY = 0
	local posX = 0
	local Time = 0
	local Template = DialogueUI.Holder.Template
	local Holder = DialogueUI.Holder
	local ImageLabel = Template:WaitForChild("ImageLabel")
	local NameLabel = Template:WaitForChild("Name")
	ImageLabel.Position = ImageLabel.Position - UDim2.new(0, 0, 0, 100)
	ImageLabel.ImageTransparency = 1
	ImageLabel.Image = "rbxassetid://6192162228"
	NameLabel.Position = NameLabel.Position - UDim2.new(0, 0, 0, 100)
	NameLabel.TextTransparency = 1
	NameLabel.TextStrokeTransparency = 1
	TweenService:Create(ImageLabel, TweenInfo.new(0.8, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
		Position = ImageLabel.Position + UDim2.new(0, 0, 0, 100),
		ImageTransparency = 0
	}):Play()
	TweenService:Create(NameLabel, TweenInfo.new(0.8, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
		Position = NameLabel.Position + UDim2.new(0, 0, 0, 100),
		TextTransparency = 0,
		TextStrokeTransparency = 0
	}):Play()
	
	DialogueUI.Parent = playerGui
	DialogueUI.Enabled = true
	DialogueUI.Name = "CUSTOM_DIALOGUE"
	CollectionService:AddTag(DialogueUI, "CUSTOM_DIALOGUE")
	NameLabel.Text = displayName
	
	local isHigh = false
	for _, v in data do
		if v.HigherUp then
			isHigh = true
			TweenService:Create(Holder, TweenInfo.new(0.2), {Position = UDim2.new(0.5, 0, 0.965, 0)}):Play()
		end
	end
	if not isHigh then
		TweenService:Create(Holder, TweenInfo.new(0.8), {Position = UDim2.new(0.5, 0, 1, 0)}):Play()
	end
	
	for _, v in data do
		local split = string.split(v.Text, "")
		local font = v.Bold and Enum.Font.SourceSansBold or v.Italic and Enum.Font.SourceSansItalic or Enum.Font.SourceSans
		for _, b in split do
			posY = posY + TextService:GetTextSize(b, 25, font, Vector2.new(100, 100)).X
		end
	end
	
	local totalTypingTime = 0
	for _, v in data do
		local split = string.split(v.Text, "")
		local font = v.Bold and Enum.Font.SourceSansBold or v.Italic and Enum.Font.SourceSansItalic or Enum.Font.SourceSans
		for _, b in split do
			local TextService_TextLabel = TextService:GetTextSize(b, 25, font, Vector2.new(100, 100))
			local TextLabel = Instance.new("TextLabel")
			local newPosY = posY
			local newPosX = posX
			TextLabel.AnchorPoint = Vector2.new(0, 0.5)
			TextLabel.Position = UDim2.new(0.5, newPosX - newPosY / 2 // 1, 0.5, 10)
			TextLabel.Size = UDim2.new(0, TextService_TextLabel.X, 0, TextService_TextLabel.Y)
			TextLabel.Text = b
			TextLabel.Name = "letter"
			TextLabel.Font = font
			TextLabel.TextSize = 25
			TextLabel.Parent = Template
			TextLabel.BackgroundTransparency = 1
			TextLabel.TextStrokeColor3 = v.TextStrokeColor
			TextLabel.TextStrokeTransparency = 1
			TextLabel.TextTransparency = 1
			task.delay(Time, function()
				local osClock = os.clock()
				repeat
					local keyPointTime = math.min((os.clock() - osClock) / 0.35, 1)
					local shakeLifeTime = math.min((os.clock() - osClock) / (v.Shake.Lifetime or 0.3), 1)
					local currentShake = not v.Shake.Enabled and UDim2.new(0, 0, 0, 0) or UDim2.new(0, math.random(-v.Shake.Intensity, v.Shake.Intensity) * (1 - shakeLifeTime), 0, math.random(-v.Shake.Intensity, v.Shake.Intensity) * (1 - shakeLifeTime))
					local textSettings = 1 - (1 + 2.70158 * math.pow(keyPointTime - 1, 3) + 1.70158 * math.pow(keyPointTime - 1, 2))
					TextLabel.TextStrokeTransparency = (1 - keyPointTime) ^ 10
					TextLabel.TextTransparency = textSettings
					TextLabel.TextSize = 25 + 25 * textSettings
					TextLabel.TextColor3 = getColor(keyPointTime, v.Color.Keypoints)
					TextLabel.Position = UDim2.new(0.5, newPosX - newPosY / 2 // 1, 0.5, 0) + currentShake
					task.wait()
				until os.clock() - osClock > math.max(0.35, v.Shake.Lifetime or 0.3) or not TextLabel or TextLabel:GetAttribute("Ending")
				if TextLabel then
					TextLabel.TextStrokeTransparency = 0
					TextLabel.TextTransparency = 0
					TextLabel.TextSize = 25
					TextLabel.TextColor3 = v.Color.Keypoints[#v.Color.Keypoints].Value
					TextLabel.Position = UDim2.new(0.5, newPosX - newPosY / 2 // 1, 0.5, 0)
				end
			end)
			Time = Time + (v.TypeSpeed or 0.03)
			posX = posX + TextService_TextLabel.X
			totalTypingTime = Time
		end
	end
	
	task.spawn(function()
		task.wait(totalTypingTime + 1) 
		EndDialogue(Template)
		TweenService:Create(ImageLabel, TweenInfo.new(0.8, Enum.EasingStyle.Quint, Enum.EasingDirection.In), {
			Position = ImageLabel.Position - UDim2.new(0, 0, 0, 100),
			ImageTransparency = 1
		}):Play()
		TweenService:Create(NameLabel, TweenInfo.new(0.8, Enum.EasingStyle.Quint, Enum.EasingDirection.In), {
			Position = NameLabel.Position - UDim2.new(0, 0, 0, 100),
			TextTransparency = 1,
			TextStrokeTransparency = 1
		}):Play()
		task.delay(0.8, function()
			DialogueUI:Destroy()
		end)
	end)
end

tool.Activated:Connect(function()
	tool:Destroy()
	
	local playerHrp = character:WaitForChild("HumanoidRootPart")
	playerHrp.Anchored = true
	
	charaRig.Parent = Workspace
	local charaHrp = charaRig:WaitForChild("HumanoidRootPart")
	local charaHead = charaRig:WaitForChild("Head")
	
	cameraModel:PivotTo(charaHrp.CFrame * CFrame.new(0, -3, 0))
	cameraModel.Parent = Workspace
	
	camera.CameraType = Enum.CameraType.Scriptable
	camera.CameraSubject = cameraPart
	camera.FieldOfView = 20
	humanoid.CameraOffset = Vector3.new(0,0,0)
	
	local camConn = RunService.RenderStepped:Connect(function()
		camera.CFrame = cameraPart.CFrame
	end)
	
	local newSky = Instance.new("Sky")
	newSky.SkyboxBk = "rbxassetid://15465935058"
	newSky.SkyboxDn = "rbxassetid://15465935058"
	newSky.SkyboxFt = "rbxassetid://15465935058"
	newSky.SkyboxLf = "rbxassetid://15465935058"
	newSky.SkyboxRt = "rbxassetid://15465935058"
	newSky.SkyboxUp = "rbxassetid://15465935058"
	newSky.Parent = Lighting
	
	local sound = Instance.new("Sound")
	sound.SoundId = getcustomasset("Reset.mp3")
	sound.Volume = 1
	sound.Parent = Workspace
	sound:Play()
	
	local camAnim = PlayKeyframeSequence(cameraModel, cameraKfs, 1)
	local charaAnim = PlayKeyframeSequence(charaRig, charaKfs, 1)
	local animLength = charaAnim.getLength()
	
	task.delay(0.001, function()
		CreateDialogue({{
			Text = "You know what we have to do...",
			TypeSpeed = 0.05,
			Bold = false,
			Italic = false,
			TextStrokeColor = Color3.new(0, 0, 0),
			HigherUp = false,
			Shake = {Enabled = true, Intensity = 3, Lifetime = 0.4},
			Color = {Keypoints = {{Time = 0, Value = Color3.new(1, 0, 0)}, {Time = 1, Value = Color3.new(1, 0, 0)}}}
		}}, player.Name)
	end)
	
	task.delay(2.8, function()
		CreateDialogue({{
			Text = "Partner.?",
			TypeSpeed = 0.05,
			Bold = false,
			Italic = true,
			TextStrokeColor = Color3.new(0, 0, 0),
			HigherUp = true,
			Shake = {Enabled = true, Intensity = 4, Lifetime = 0.4},
			Color = {Keypoints = {{Time = 0, Value = Color3.new(1, 0, 0)}, {Time = 1, Value = Color3.new(1, 0, 0)}}}
		}}, player.Name)
	end)
	
	task.delay(4.9, function()
		CreateDialogue({{
			Text = "It was fun while it lasted.",
			TypeSpeed = 0.05,
			Bold = false,
			Italic = false,
			TextStrokeColor = Color3.new(0, 0, 0),
			HigherUp = false,
			Shake = {Enabled = false, Intensity = 0, Lifetime = 0},
			Color = {Keypoints = {{Time = 0, Value = Color3.new(1, 0, 0)}, {Time = 1, Value = Color3.new(1, 0, 0)}}}
		}}, player.Name)
	end)
	
	task.delay(9, function()
		local face = charaHead:FindFirstChild("Face")
		if face then
			face:Destroy()
		end
		local scaryface = charaRig:FindFirstChild("scaryface")
		if scaryface and scaryface:IsA("BasePart") then
			scaryface.Transparency = 0
		end
	end)
	
	task.delay(10, function()
		TweenService:Create(blackFrame, TweenInfo.new(0.5, Enum.EasingStyle.Linear), {BackgroundTransparency = 0}):Play()
		
		task.delay(0.5, function()
			TweenService:Create(slashImage, TweenInfo.new(0.2), {ImageTransparency = 0}):Play()
			task.delay(0.4, function()
				TweenService:Create(slashImage, TweenInfo.new(0.3), {ImageTransparency = 1}):Play()
			end)
			
			task.delay(1, function()
				TweenService:Create(damageImage, TweenInfo.new(0.2), {ImageTransparency = 0}):Play()
				
				local shakeConn
				shakeConn = RunService.Heartbeat:Connect(function()
					local offsetX = math.random(-8, 8)
					local offsetY = math.random(-8, 8)
					damageImage.Position = UDim2.new(0, offsetX, 0, offsetY)
				end)
				
				task.delay(1.5, function()
					shakeConn:Disconnect()
					damageImage.Position = UDim2.new(0, 0, 0, 0)
					TweenService:Create(damageImage, TweenInfo.new(0.4), {ImageTransparency = 1}):Play()
				end)
			end)
		end)
		
		task.delay(5, function()
			TweenService:Create(blackFrame, TweenInfo.new(0.5, Enum.EasingStyle.Linear), {BackgroundTransparency = 1}):Play()
		end)
	end)
	
	task.delay(animLength, function()
		camAnim.stop()
		charaAnim.stop()
		
		if camConn then camConn:Disconnect() end
		
		playerHrp.Anchored = false
		
		camera.CameraType = originalCameraType
		camera.CameraSubject = originalCameraSubject
		camera.FieldOfView = originalFieldOfView
		
		humanoid.Health = 0
		
		cameraModel:Destroy()
		charaRig:Destroy()
		if newSky then newSky:Destroy() end
		
		task.delay(1, function()
			screenGui:Destroy()
		end)
	end)
end)
