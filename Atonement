local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")
local rightArm = character:WaitForChild("Right Arm")
local head = character:WaitForChild("Head")
local backpack = player:WaitForChild("Backpack")

local tool = Instance.new("Tool")
tool.Name = "Atonement"
tool.RequiresHandle = false
tool.CanBeDropped = false
tool.Parent = backpack

local camera = Workspace.CurrentCamera
local originalCameraSubject = camera.CameraSubject
local originalCameraType = camera.CameraType
local originalFieldOfView = camera.FieldOfView

local assets = game:GetObjects(getcustomasset("CHARA.rbxmx"))[1]
local knifeModel = assets:WaitForChild("Knife")
local atonementCamModel = assets:WaitForChild("AtonementCam")
local atonementCamPart = atonementCamModel:WaitForChild("Camera")
local atonementCamKnife = atonementCamModel:FindFirstChild("Knife")
local atonementHit = assets:WaitForChild("Keyframes"):WaitForChild("AtonementHit")
local atonementVictim = assets:WaitForChild("Keyframes"):WaitForChild("AntonementHitVictim")
local deathCharge = assets:WaitForChild("Keyframes"):WaitForChild("DeathCharge")
local deathChargeVictim = assets:WaitForChild("Keyframes"):WaitForChild("DeathChargeVictim")
local deathChargeCam = assets:WaitForChild("Keyframes"):WaitForChild("DeathChargeCam")

local knifeMeshes = {}
for _, obj in ipairs(knifeModel:GetDescendants()) do
	if obj:IsA("MeshPart") or obj:IsA("Part") then
		table.insert(knifeMeshes, obj)
	end
end

local camKnifeMeshes = {}
if atonementCamKnife then
	for _, obj in ipairs(atonementCamKnife:GetDescendants()) do
		if obj:IsA("MeshPart") or obj:IsA("Part") then
			table.insert(camKnifeMeshes, obj)
		end
	end
end

local function SetKnifeVisible(visible)
	local transparency = visible and 0 or 1
	for _, mesh in ipairs(knifeMeshes) do
		if mesh and mesh.Parent then
			mesh.Transparency = transparency
		end
	end
end

local function SetCamKnifeVisible(visible)
	local transparency = visible and 0 or 1
	for _, mesh in ipairs(camKnifeMeshes) do
		if mesh and mesh.Parent then
			mesh.Transparency = transparency
		end
	end
end

SetKnifeVisible(false)
knifeModel.Parent = character

local tStyle = {
	[Enum.PoseEasingStyle.Linear] = Enum.EasingStyle.Linear,
	[Enum.PoseEasingStyle.Bounce] = Enum.EasingStyle.Bounce,
	[Enum.PoseEasingStyle.Cubic] = Enum.EasingStyle.Cubic,
	[Enum.PoseEasingStyle.Elastic] = Enum.EasingStyle.Elastic,
	[Enum.PoseEasingStyle.Constant] = Enum.EasingStyle.Linear,
}

local tDirection = {
	[Enum.PoseEasingDirection.In] = Enum.EasingDirection.In,
	[Enum.PoseEasingDirection.Out] = Enum.EasingDirection.Out,
	[Enum.PoseEasingDirection.InOut] = Enum.EasingDirection.InOut,
}

function PlayKeyframeSequence(Model, KeyFrameSequence, SpeedMult)
	SpeedMult = SpeedMult or 1
	local AllKeyFrames = {}
	for _, Keyframe in pairs(KeyFrameSequence:GetKeyframes()) do
		table.insert(AllKeyFrames, {Time = Keyframe.Time, Keyframe = Keyframe})
	end
	table.sort(AllKeyFrames, function(a,b) return a.Time < b.Time end)

	if #AllKeyFrames == 0 then return {getLength = function() return 0 end, stop = function() end, play = function() end} end

	local motors = {}
	local motorValues = {}
	local tweens = {}
	local connection

	local function GetMotorFromPose(Pose)
		for _, v in pairs(Model:GetDescendants()) do
			if v:IsA("Motor6D") and v.Part1 and v.Part1.Name == Pose.Name and v.Part0 and v.Part0.Name == Pose.Parent.Name then
				return v
			end
		end
	end

	for _, Keyframe in ipairs(AllKeyFrames) do
		for _, Pose in pairs(Keyframe.Keyframe:GetDescendants()) do
			if Pose:IsA("Pose") and Pose.Weight > 0 then
				local Motor6D = motors[Pose.Name] or GetMotorFromPose(Pose)
				if Motor6D then
					motors[Pose.Name] = Motor6D
					if not motorValues[Pose.Name] then
						local motorVal = Instance.new("CFrameValue")
						motorVal.Name = "MotorValue_" .. tick()
						motorVal.Parent = Motor6D
						motorVal.Value = Motor6D.Transform
						motorValues[Pose.Name] = motorVal
					end
				end
			end
		end
	end

	local totalTime = 0
	if #AllKeyFrames > 1 then
		for i = 1, #AllKeyFrames - 1 do
			local KF1, KF2 = AllKeyFrames[i], AllKeyFrames[i+1]
			local duration = (KF2.Time - KF1.Time) / SpeedMult
			totalTime += duration

			for _, Pose in pairs(KF2.Keyframe:GetDescendants()) do
				if Pose:IsA("Pose") and Pose.Weight > 0 and motors[Pose.Name] then
					local tweenInfo = TweenInfo.new(
						duration,
						tStyle[Pose.EasingStyle] or Enum.EasingStyle.Linear,
						tDirection[Pose.EasingDirection] or Enum.EasingDirection.InOut
					)
					table.insert(tweens, {
						Tween = TweenService:Create(motorValues[Pose.Name], tweenInfo, {Value = Pose.CFrame}),
						Delay = totalTime - duration
					})
				end
			end
		end
	end

	local function getLength()
		return AllKeyFrames[#AllKeyFrames].Time / SpeedMult
	end

	local function play()
		connection = RunService.Heartbeat:Connect(function()
			for name, motor in pairs(motors) do
				if motorValues[name] then
					motor.Transform = motorValues[name].Value
				end
			end
		end)

		for _, data in ipairs(tweens) do
			task.delay(data.Delay, function()
				if data.Tween then
					data.Tween:Play()
				end
			end)
		end

		task.spawn(function()
			task.wait(getLength())
			if connection then
				connection:Disconnect()
				connection = nil
			end
		end)
	end

	local function stop()
		if connection then
			connection:Disconnect()
			connection = nil
		end
		for _, data in ipairs(tweens) do
			if data.Tween then
				data.Tween:Cancel()
			end
		end
		for _, val in pairs(motorValues) do
			if val and val.Parent then
				val:Destroy()
			end
		end
	end

	return {
		getLength = getLength,
		play = play,
		stop = stop
	}
end

local function CloneCharacter(targetChar)
	targetChar.Archivable = true
	local clone = targetChar:Clone()
	targetChar.Archivable = false
	return clone
end

local dummyNpc = nil

local function CreateDummy()
	if dummyNpc and dummyNpc.Parent then
		dummyNpc:Destroy()
	end

	local obj = game:GetObjects("rbxassetid://74478360128080")[1]
	if obj:FindFirstChild("HumanoidRootPart") then
		obj.HumanoidRootPart.Anchored = true
	end
	for _, part in ipairs(obj:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CanCollide = false
		end
	end
	dummyNpc = obj
	return dummyNpc
end

local isAnimating = false
local currentKnifeMotor = nil
local camConn = nil
local currentCamModel = nil

tool.Activated:Connect(function()
	if isAnimating then return end

	local closestPlayer = nil
	local closestDist = 50
	local closestChar = nil

	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (hrp.Position - p.Character.HumanoidRootPart.Position).Magnitude
			if dist < closestDist then
				closestDist = dist
				closestPlayer = p
				closestChar = p.Character
			end
		end
	end

	if not closestChar then
		local dummy = CreateDummy()
		if dummy and dummy:FindFirstChild("HumanoidRootPart") then
			dummy.HumanoidRootPart.CFrame = hrp.CFrame * CFrame.new(0, 0, -5)
			closestChar = dummy
		else
			return
		end
	end

	isAnimating = true

	local originalAnimator = humanoid:FindFirstChildOfClass("Animator")
	if originalAnimator then
		originalAnimator:Destroy()
	end

	camera.CameraSubject = head
	hrp.Anchored = true

	SetKnifeVisible(true)

	local handle = knifeModel:FindFirstChild("Handle")
	if handle then
		handle.Anchored = false
	end

	if currentKnifeMotor and currentKnifeMotor.Parent then
		currentKnifeMotor:Destroy()
	end

	currentKnifeMotor = Instance.new("Motor6D")
	currentKnifeMotor.Name = "RightGrip"
	currentKnifeMotor.Part0 = rightArm
	currentKnifeMotor.Part1 = handle
	currentKnifeMotor.C0 = CFrame.new(0, -1, 0) * CFrame.Angles(0, 0, math.rad(-90)) * CFrame.Angles(math.rad(-90), 0, 0) * CFrame.Angles(0, math.rad(180), 0)
	currentKnifeMotor.Parent = rightArm

	local sound = Instance.new("Sound")
	sound.SoundId = getcustomasset("Atonement.mp3")
	sound.Volume = 1
	sound.Parent = Workspace
	sound:Play()

	local targetChar = closestChar
	local playerAnim = PlayKeyframeSequence(character, atonementHit, 1.1)

	local victimClone = CloneCharacter(targetChar)
	victimClone.Parent = Workspace

	for _, part in ipairs(victimClone:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CanCollide = false
		end
	end

	local victimHrp = victimClone:FindFirstChild("HumanoidRootPart")
	local victimHead = victimClone:FindFirstChild("Head")
	local victimAnim = nil
	local weld = nil

	if victimHrp then
		victimHrp.CFrame = hrp.CFrame * CFrame.new(0, 0, -3) * CFrame.Angles(0, math.rad(180), 0)
		weld = Instance.new("WeldConstraint")
		weld.Part0 = hrp
		weld.Part1 = victimHrp
		weld.Parent = hrp
		victimAnim = PlayKeyframeSequence(victimClone, atonementVictim, 1.1)
	end

	playerAnim.play()
	if victimAnim then
		victimAnim.play()
	end

	task.spawn(function()
		task.wait(5)
		if victimHead and victimHead.Parent then
			camera.CameraSubject = victimHead
		end
	end)

	local animDuration = math.max(playerAnim.getLength(), victimAnim and victimAnim.getLength() or 0)

	task.delay(animDuration, function()
		playerAnim.stop()
		if victimAnim then
			victimAnim.stop()
		end

		local deathSound = Instance.new("Sound")
		deathSound.SoundId = getcustomasset("DeathCharge.mp3")
		deathSound.Volume = 1
		deathSound.Parent = Workspace
		deathSound:Play()

		currentCamModel = atonementCamModel:Clone()
		currentCamModel:PivotTo(hrp.CFrame)
		currentCamModel.Parent = Workspace

		local currentCamPart = currentCamModel:FindFirstChild("Camera")
		SetCamKnifeVisible(true)

		camera.CameraType = Enum.CameraType.Scriptable
		camera.CameraSubject = currentCamPart
		camera.FieldOfView = 50

		if camConn then camConn:Disconnect() end
		camConn = RunService.RenderStepped:Connect(function()
			camera.CFrame = currentCamPart.CFrame
		end)

		local deathCamAnim = PlayKeyframeSequence(currentCamModel, deathChargeCam, 1)
		deathCamAnim.play()

		local deathPlayerAnim = PlayKeyframeSequence(character, deathCharge, 1)
		local deathVictimAnim = victimClone and PlayKeyframeSequence(victimClone, deathChargeVictim, 1)

		deathPlayerAnim.play()
		if deathVictimAnim then
			deathVictimAnim.play()
		end

		task.spawn(function()
			task.wait(5)
			SetCamKnifeVisible(false)
			task.wait(3)
			SetCamKnifeVisible(true)
		end)

		local playerHighlight = Instance.new("Highlight")
		playerHighlight.FillTransparency = 1
		playerHighlight.OutlineColor = Color3.new(1, 1, 1)
		playerHighlight.OutlineTransparency = 0

		local colorCorrection = Instance.new("ColorCorrectionEffect")
		colorCorrection.Saturation = -1
		colorCorrection.Contrast = 0.2
		colorCorrection.Brightness = 0

		local sky = Instance.new("Sky")
		sky.SkyboxBk = "rbxassetid://15465935058"
		sky.SkyboxDn = "rbxassetid://15465935058"
		sky.SkyboxFt = "rbxassetid://15465935058"
		sky.SkyboxLf = "rbxassetid://15465935058"
		sky.SkyboxRt = "rbxassetid://15465935058"
		sky.SkyboxUp = "rbxassetid://15465935058"

		task.delay(8, function()
			playerHighlight.Parent = character
			colorCorrection.Parent = Lighting
			sky.Parent = Lighting
		end)

		local deathDuration = math.max(deathPlayerAnim.getLength(), deathVictimAnim and deathVictimAnim.getLength() or 0, deathCamAnim.getLength())

		task.delay(deathDuration, function()
			deathPlayerAnim.stop()
			if deathVictimAnim then
				deathVictimAnim.stop()
			end
			deathCamAnim.stop()

			if camConn then
				camConn:Disconnect()
				camConn = nil
			end

			hrp.Anchored = false
			camera.CameraType = originalCameraType
			camera.CameraSubject = originalCameraSubject
			camera.FieldOfView = originalFieldOfView

			if not humanoid:FindFirstChildOfClass("Animator") then
				local newAnimator = Instance.new("Animator")
				newAnimator.Parent = humanoid
			end

			SetKnifeVisible(false)

			if weld and weld.Parent then
				weld:Destroy()
			end

			if victimClone and victimClone.Parent then
				victimClone:Destroy()
			end

			if currentCamModel and currentCamModel.Parent then
				currentCamModel:Destroy()
			end

			if playerHighlight and playerHighlight.Parent then
				playerHighlight:Destroy()
			end

			if colorCorrection and colorCorrection.Parent then
				colorCorrection:Destroy()
			end

			if sky and sky.Parent then
				sky:Destroy()
			end

			isAnimating = false
		end)
	end)
end)
